# ğŸ”’ STAGE 3 SECURITY CHECKLIST & BEST PRACTICES

## ğŸ¯ Security-First Development Mindset

Giai Ä‘oáº¡n 3 focus heavy vÃ o security. ÄÃ¢y lÃ  checklist Ä‘á»ƒ ensure báº¡n implement security correctly.

---

## ğŸª COOKIES & SESSIONS SECURITY

### **Cookie Security Checklist:**

```
ğŸ’¡ Há»i AI: "Review cookie security implementation theo checklist nÃ y"
```

**Essential Cookie Attributes:**

- [ ] âœ… `httpOnly: true` - Prevent XSS access to cookies
- [ ] âœ… `secure: true` - HTTPS only cookies (production)
- [ ] âœ… `sameSite: 'strict'` hoáº·c `'lax'` - CSRF protection
- [ ] âœ… Appropriate `maxAge` - Don't keep cookies forever
- [ ] âœ… Proper `domain` vÃ  `path` - Scope limitation

**Session Security:**

- [ ] âœ… Strong session secret (environment variable)
- [ ] âœ… Session regeneration after login
- [ ] âœ… Session cleanup on logout
- [ ] âœ… Session timeout implementation
- [ ] âœ… Secure session store (not MemoryStore in production)

**Code Example:**

```javascript
// âœ… Secure cookie setup
app.use(
  session({
    secret: process.env.SESSION_SECRET, // Strong, random secret
    resave: false,
    saveUninitialized: false,
    cookie: {
      secure: process.env.NODE_ENV === "production", // HTTPS only in prod
      httpOnly: true, // Prevent XSS
      maxAge: 24 * 60 * 60 * 1000, // 24 hours
      sameSite: "strict", // CSRF protection
    },
    store: new RedisStore({ client: redisClient }), // Persistent store
  })
);
```

---

## ğŸ” AUTHENTICATION SECURITY

### **Password Security Checklist:**

```
ğŸ’¡ Há»i AI: "Audit password security implementation"
```

**Password Hashing:**

- [ ] âœ… Never store plain text passwords
- [ ] âœ… Use bcrypt vá»›i appropriate salt rounds (10-12)
- [ ] âœ… Async hashing Ä‘á»ƒ avoid blocking
- [ ] âœ… Password comparison vá»›i bcrypt.compare()

**Password Requirements:**

- [ ] âœ… Minimum length (8+ characters)
- [ ] âœ… Complexity requirements (optional but recommended)
- [ ] âœ… Password confirmation matching
- [ ] âœ… Password strength indicator (UX)

**Login Security:**

- [ ] âœ… Rate limiting cho login attempts
- [ ] âœ… Account lockout after failed attempts
- [ ] âœ… Secure password reset flow
- [ ] âœ… Email notification cá»§a suspicious activity

**Code Example:**

```javascript
// âœ… Secure password hashing
const bcrypt = require("bcrypt");
const SALT_ROUNDS = 12;

// Registration
const hashedPassword = await bcrypt.hash(password, SALT_ROUNDS);

// Login verification
const isValidPassword = await bcrypt.compare(password, user.hashedPassword);
```

### **Authentication Flow Security:**

- [ ] âœ… Input validation trÃªn login form
- [ ] âœ… Error messages don't reveal user existence
- [ ] âœ… Login attempt logging
- [ ] âœ… Session regeneration after successful login
- [ ] âœ… Proper logout implementation

---

## ğŸ‘¥ AUTHORIZATION SECURITY

### **Role-Based Access Control:**

```
ğŸ’¡ Há»i AI: "Review RBAC implementation security"
```

**Role Management:**

- [ ] âœ… Default role assignment (least privilege)
- [ ] âœ… Role validation middleware
- [ ] âœ… Permission checking before resource access
- [ ] âœ… Proper 401 vs 403 responses
- [ ] âœ… Resource ownership verification

**Authorization Middleware:**

```javascript
// âœ… Secure authorization middleware
const requireRole = (roles) => {
  return (req, res, next) => {
    if (!req.session.user) {
      return res.status(401).json({ error: "Authentication required" });
    }

    if (!roles.includes(req.session.user.role)) {
      return res.status(403).json({ error: "Insufficient permissions" });
    }

    next();
  };
};

// Usage
app.get("/admin", requireRole(["admin"]), adminController);
```

**Resource Protection:**

- [ ] âœ… Check resource ownership
- [ ] âœ… Validate resource access permissions
- [ ] âœ… Log authorization failures
- [ ] âœ… Implement principle of least privilege

---

## âœ… INPUT VALIDATION SECURITY

### **Validation Security Checklist:**

```
ğŸ’¡ Há»i AI: "Security audit cho input validation implementation"
```

**Essential Validations:**

- [ ] âœ… **Server-side validation** (never trust client)
- [ ] âœ… **Input type validation** (string, number, email, etc.)
- [ ] âœ… **Length limitations** (prevent buffer overflow)
- [ ] âœ… **Format validation** (regex patterns)
- [ ] âœ… **Whitelist approach** (allow known good vs block known bad)

**Sanitization Security:**

- [ ] âœ… **HTML encoding** Ä‘á»ƒ prevent XSS
- [ ] âœ… **SQL injection prevention** (ORM protection)
- [ ] âœ… **Script tag removal** tá»« user input
- [ ] âœ… **File upload validation** (type, size, content)
- [ ] âœ… **Path traversal prevention** (../../../etc/passwd)

**Code Example:**

```javascript
// âœ… Comprehensive validation
const { body, validationResult } = require("express-validator");

const validateUserInput = [
  body("email").isEmail().normalizeEmail().escape(), // Prevent XSS

  body("username")
    .isLength({ min: 3, max: 20 })
    .matches(/^[a-zA-Z0-9_]+$/) // Alphanumeric + underscore only
    .escape(),

  body("message").isLength({ max: 1000 }).trim().escape(), // Remove HTML

  (req, res, next) => {
    const errors = validationResult(req);
    if (!errors.isEmpty()) {
      return res.status(400).json({
        errors: errors.array(),
      });
    }
    next();
  },
];
```

### **File Upload Security:**

- [ ] âœ… File type validation (whitelist approach)
- [ ] âœ… File size limits
- [ ] âœ… Virus scanning (if applicable)
- [ ] âœ… Secure file storage location
- [ ] âœ… File name sanitization

---

## ğŸ“§ EMAIL SECURITY

### **Email Security Checklist:**

```
ğŸ’¡ Há»i AI: "Email security best practices implementation review"
```

**Email Authentication:**

- [ ] âœ… SMTP authentication vá»›i app passwords
- [ ] âœ… API key security cho email services
- [ ] âœ… Environment variable storage
- [ ] âœ… Rate limiting cho email sending

**Email Content Security:**

- [ ] âœ… HTML sanitization trong emails
- [ ] âœ… Link validation vÃ  safety
- [ ] âœ… Attachment scanning
- [ ] âœ… Spam filter compliance

**Privacy & Compliance:**

- [ ] âœ… Unsubscribe mechanism
- [ ] âœ… GDPR compliance
- [ ] âœ… Data retention policies
- [ ] âœ… Email logging vÃ  audit trail

**Code Example:**

```javascript
// âœ… Secure email configuration
const nodemailer = require("nodemailer");

const transporter = nodemailer.createTransporter({
  service: "gmail",
  auth: {
    user: process.env.EMAIL_USER,
    pass: process.env.EMAIL_APP_PASSWORD, // App password, not regular password
  },
});

// âœ… Secure email sending vá»›i validation
const sendSecureEmail = async (to, subject, htmlContent) => {
  // Validate email address
  if (!validator.isEmail(to)) {
    throw new Error("Invalid email address");
  }

  // Sanitize HTML content
  const sanitizedContent = sanitizeHtml(htmlContent);

  const mailOptions = {
    from: process.env.EMAIL_FROM,
    to: to,
    subject: subject,
    html: sanitizedContent,
  };

  await transporter.sendMail(mailOptions);
};
```

---

## ğŸ’³ PAYMENT SECURITY

### **Payment Security Checklist:**

```
ğŸ’¡ Há»i AI: "Payment security implementation audit"
```

**PCI DSS Compliance:**

- [ ] âœ… Never store card data
- [ ] âœ… Use Stripe.js cho card collection
- [ ] âœ… HTTPS enforcement
- [ ] âœ… Secure API key management
- [ ] âœ… Payment logging (without sensitive data)

**Stripe Integration Security:**

- [ ] âœ… Webhook signature verification
- [ ] âœ… Idempotency key usage
- [ ] âœ… Amount validation server-side
- [ ] âœ… Currency validation
- [ ] âœ… Fraud monitoring

**Code Example:**

```javascript
// âœ… Secure webhook handling
app.post(
  "/stripe/webhook",
  express.raw({ type: "application/json" }),
  (req, res) => {
    const sig = req.headers["stripe-signature"];

    try {
      // Verify webhook signature
      const event = stripe.webhooks.constructEvent(
        req.body,
        sig,
        process.env.STRIPE_WEBHOOK_SECRET
      );

      // Handle event securely
      switch (event.type) {
        case "payment_intent.succeeded":
          // Process successful payment
          break;
        default:
          console.log(`Unhandled event type ${event.type}`);
      }

      res.json({ received: true });
    } catch (err) {
      console.log(`Webhook signature verification failed.`, err.message);
      return res.status(400).send(`Webhook Error: ${err.message}`);
    }
  }
);
```

---

## ğŸ›¡ï¸ GENERAL SECURITY MEASURES

### **Environment Security:**

```
ğŸ’¡ Há»i AI: "Environment vÃ  deployment security review"
```

**Environment Variables:**

- [ ] âœ… All secrets trong environment variables
- [ ] âœ… No hardcoded passwords/keys
- [ ] âœ… Separate configs cho dev/staging/prod
- [ ] âœ… .env files trong .gitignore

**HTTP Security Headers:**

- [ ] âœ… Use Helmet.js middleware
- [ ] âœ… Content Security Policy (CSP)
- [ ] âœ… X-Frame-Options
- [ ] âœ… X-XSS-Protection
- [ ] âœ… Strict-Transport-Security

**Error Handling Security:**

- [ ] âœ… Don't expose stack traces trong production
- [ ] âœ… Generic error messages cho users
- [ ] âœ… Detailed logging cho developers
- [ ] âœ… Error monitoring vÃ  alerting

---

## ğŸ” SECURITY TESTING

### **Testing Checklist:**

```
ğŸ’¡ Há»i AI: "Security testing approach cho Stage 3 applications"
```

**Manual Testing:**

- [ ] âœ… SQL injection attempts
- [ ] âœ… XSS payload testing
- [ ] âœ… Authentication bypass attempts
- [ ] âœ… Authorization escalation testing
- [ ] âœ… CSRF attack simulation

**Automated Testing:**

- [ ] âœ… npm audit cho dependencies
- [ ] âœ… Security linting rules
- [ ] âœ… Unit tests cho security functions
- [ ] âœ… Integration tests cho auth flows

**Tools to Use:**

- [ ] âœ… OWASP ZAP
- [ ] âœ… Snyk vulnerability scanning
- [ ] âœ… ESLint security plugins
- [ ] âœ… Helmet.js security headers

---

## ğŸ“ SECURITY DOCUMENTATION

### **Documentation Requirements:**

- [ ] âœ… Security architecture documentation
- [ ] âœ… Authentication flow diagrams
- [ ] âœ… Authorization matrix
- [ ] âœ… Incident response procedures
- [ ] âœ… Security testing results

**Regular Security Tasks:**

- [ ] âœ… Weekly dependency updates
- [ ] âœ… Monthly security audits
- [ ] âœ… Quarterly penetration testing
- [ ] âœ… Annual security training

---

**Remember: Security is not a feature, it's a process. Implement security from day one vÃ  continuously monitor vÃ  improve! ğŸ›¡ï¸**
